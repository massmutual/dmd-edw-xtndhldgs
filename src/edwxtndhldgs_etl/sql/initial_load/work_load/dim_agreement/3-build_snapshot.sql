-- SNAPSHOT FOR AGMT_DATA
-- ADD SLEEP FUNCTION FOR MPR SPECIFIC BASED ON DATA VOLUME FOR NOW
-- SLEEP AT RUN_ID: 100, 600, 1000
--SELECT
--CASE WHEN :RUN_ID=100 THEN SLEEP(600)
--     WHEN :RUN_ID=600 THEN SLEEP(600)
--     WHEN :RUN_ID=1000 THEN SLEEP(600)
--     ELSE 0
--     END;

-- DELETE THE CHANGED RECORD IN SNAPSHOT, MAKE SURE SNAPSHOT IS ALL NEW
DELETE FROM EDW_STAGING.AIFRPS_AGMT_DATA_VW_SNAPSHOT
WHERE AGMT_ID IN (SELECT AGMT_ID FROM PROD_STND_VW_TERSUN.AGMT_DATA_VW_AIF_RPS WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72);

-- SET ALL CURRENT_BATCH TO FALSE
UPDATE EDW_STAGING.AIFRPS_AGMT_DATA_VW_SNAPSHOT
SET CURRENT_BATCH = FALSE
WHERE CURRENT_BATCH = TRUE;

-- INSERT INTO NEW DATA'S
INSERT INTO EDW_STAGING.AIFRPS_AGMT_DATA_VW_SNAPSHOT
(
AGMT_ID,
AGMT_FR_DT,
AGMT_DATA_FR_DT,
AGMT_DATA_TO_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
STUS_CD,
SRC_STUS_CD,
STUS_RSN_CD,
SRC_STUS_RSN_CD,
STUS_DT,
PROD_ID,
PROD_TYP_CD_1,
PROD_TYP_CD_2,
PROD_TYP_CD_3,
CTRT_DT,
ISS_DT,
MATR_DT,
ANNV_DT,
TRMN_DT,
APP_RCVD_DT,
APP_SGND_DT,
CONV_OPT_EXP_DT,
MRKT_TYP_CD,
SRC_MRKT_TYP_CD,
TAX_QUAL_IND,
SRC_TAX_QUAL_IND,
SRC_PLAN_TYP_CD,
RPLCMT_TYP_CD,
SRC_RPLCMT_TYP_CD,
RSTCT_CD,
SRC_RSTCT_CD,
RSTCT_CTGRY_CD,
SRC_RSTCT_CTGRY_CD,
CO_CD,
SRC_CO_CD,
FRZN_CD,
SRC_FRZN_CD,
HO_AMT_SUSP_IND,
SRC_HO_AMT_SUSP_IND,
LOST_INSD_IND,
SRC_LOST_INSD_IND,
TTL_MSG,
OFFR_ACPT_CD,
SRC_OFFR_ACPT_CD,
SRC_VBL_PROD_CD,
CTRT_ST,
TAX_ACCT_NO,
READBLTY_CD,
VNTG_RSTCT_IND,
SRC_READABLTY_CD,
SUSPEND_CD,
SRC_SUSPEND_CD,
SRC_PROD_SHT_NM,
SRC_PROD_LNG_NM,
SPCL_HNDL_CD,
SRC_SPCL_HNDL_CD,
ISS_RSN_CD,
SRC_ISS_RSN_CD,
CDSC_PRD_YR,
RNWL_DT,
RTR_GRD_IND,
SRC_ADMN_ERR_IND,
SRC_PEND_ACTV_CD,
CURR_IND,
SRC_DEL_IND,
SRC_HLDG_KEY,
SRC_SYS_ID,
RUN_ID,
UPDT_RUN_ID,
TRANS_DT,
WORKSITE_IND,
PROD_GRP_CD,
UPDT_ST_CD,
HO_AGY_SUSP_IND,
PROD_TYP,
DTRB_CLI_ACCT_ID,
RES_ST,
SLCTN_ST,
DTRB_CHNL_CD,
SRC_DTRB_CHNL_CD,
PROD_TIER_CD,
RPLCMT_IND,
SRC_RPLCMT_IND,
SPEC_COND_CDE,
SPEC_COND_CTGY,
SPEC_COND_CDE_RSN,
SPEC_COND2_CDE,
SPEC_COND2_CTGY,
SPEC_COND2_CDE_RSN,
SPM_GRP_SUSP_IND,
SPM_IND_SUSP_IND,
SPM_GRP_AR_SUSP_IND,
ACTVLY_AT_WRK_IND,
MRKT_GRP_CD,
PT_TRANS_TO_INSD_DT,
MANAGERIAL_IND,
INIT_PD_TO_DT,
INSURED_IPN,
LIVING_BENE_NOTICE_CD,
SRC_LIVING_BENE_NOTICE_CD,
LOCK_IN_CD,
SRC_LOCK_IN_CD,
AB_IB_LOCK_IN_DT,
CURRENT_BATCH
)
SELECT
AGMT_ID,
AGMT_FR_DT,
AGMT_DATA_FR_DT,
AGMT_DATA_TO_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
STUS_CD,
SRC_STUS_CD,
STUS_RSN_CD,
SRC_STUS_RSN_CD,
STUS_DT,
PROD_ID,
PROD_TYP_CD_1,
PROD_TYP_CD_2,
PROD_TYP_CD_3,
CTRT_DT,
ISS_DT,
MATR_DT,
ANNV_DT,
TRMN_DT,
APP_RCVD_DT,
APP_SGND_DT,
CONV_OPT_EXP_DT,
MRKT_TYP_CD,
SRC_MRKT_TYP_CD,
TAX_QUAL_IND,
SRC_TAX_QUAL_IND,
SRC_PLAN_TYP_CD,
RPLCMT_TYP_CD,
SRC_RPLCMT_TYP_CD,
RSTCT_CD,
SRC_RSTCT_CD,
RSTCT_CTGRY_CD,
SRC_RSTCT_CTGRY_CD,
CO_CD,
SRC_CO_CD,
FRZN_CD,
SRC_FRZN_CD,
HO_AMT_SUSP_IND,
SRC_HO_AMT_SUSP_IND,
LOST_INSD_IND,
SRC_LOST_INSD_IND,
TTL_MSG,
OFFR_ACPT_CD,
SRC_OFFR_ACPT_CD,
SRC_VBL_PROD_CD,
CTRT_ST,
TAX_ACCT_NO,
READBLTY_CD,
VNTG_RSTCT_IND,
SRC_READABLTY_CD,
SUSPEND_CD,
SRC_SUSPEND_CD,
SRC_PROD_SHT_NM,
SRC_PROD_LNG_NM,
SPCL_HNDL_CD,
SRC_SPCL_HNDL_CD,
ISS_RSN_CD,
SRC_ISS_RSN_CD,
CDSC_PRD_YR,
RNWL_DT,
RTR_GRD_IND,
SRC_ADMN_ERR_IND,
SRC_PEND_ACTV_CD,
CURR_IND,
SRC_DEL_IND,
SRC_HLDG_KEY,
SRC_SYS_ID,
RUN_ID,
UPDT_RUN_ID,
TRANS_DT,
WORKSITE_IND,
PROD_GRP_CD,
UPDT_ST_CD,
HO_AGY_SUSP_IND,
PROD_TYP,
DTRB_CLI_ACCT_ID,
RES_ST,
SLCTN_ST,
DTRB_CHNL_CD,
SRC_DTRB_CHNL_CD,
PROD_TIER_CD,
RPLCMT_IND,
SRC_RPLCMT_IND,
SPEC_COND_CDE,
SPEC_COND_CTGY,
SPEC_COND_CDE_RSN,
SPEC_COND2_CDE,
SPEC_COND2_CTGY,
SPEC_COND2_CDE_RSN,
SPM_GRP_SUSP_IND,
SPM_IND_SUSP_IND,
SPM_GRP_AR_SUSP_IND,
ACTVLY_AT_WRK_IND,
MRKT_GRP_CD,
PT_TRANS_TO_INSD_DT,
MANAGERIAL_IND,
INIT_PD_TO_DT,
INSURED_IPN,
LIVING_BENE_NOTICE_CD,
SRC_LIVING_BENE_NOTICE_CD,
LOCK_IN_CD,
SRC_LOCK_IN_CD,
AB_IB_LOCK_IN_DT,
TRUE 
FROM 
(
SELECT *,RANK() OVER(PARTITION BY HLDG_KEY,RUN_ID,TRANS_DT,HLDG_KEY_SFX,HLDG_KEY_PFX ORDER BY AGMT_DATA_TO_DT DESC) AS RANK_NUM
FROM PROD_STND_VW_TERSUN.AGMT_DATA_VW_AIF_RPS 
WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72 ) T1
WHERE T1.RANK_NUM=1;

-- SNAPSHOT FOR AGMT_BEN_DATA

-- DELETE THE CHANGED RECORD IN SNAPSHOT, MAKE SURE SNAPSHOT IS ALL NEW
DELETE FROM EDW_STAGING.AIFRPS_AGMT_BEN_DATA_VW_SNAPSHOT
WHERE AGMT_ID IN (SELECT AGMT_ID FROM PROD_STND_VW_TERSUN.AGMT_BEN_DATA_VW_AIF_RPS WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72);

-- SET ALL CURRENT_BATCH TO FALSE
UPDATE EDW_STAGING.AIFRPS_AGMT_BEN_DATA_VW_SNAPSHOT
SET CURRENT_BATCH = FALSE
WHERE CURRENT_BATCH = TRUE;

-- INSERT INTO NEW DATA'S
INSERT INTO EDW_STAGING.AIFRPS_AGMT_BEN_DATA_VW_SNAPSHOT
(
AGMT_ID,
AGMT_DATA_FR_DT,
AGMT_BEN_DATA_FR_DT,
AGMT_BEN_DATA_TO_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
ACTY_PEND_CD,
SRC_ACTY_PEND_CD,
ACTY_PEND_WD,
SRC_ACTY_PEND_WD,
APD_IND,
SRC_APD_IND,
APM_NBR,
SRC_APM_NBR,
APL_IND,
SRC_APL_IND,
CONV_IND,
SRC_CONV_IND,
CONV_ELIG_STRT_DT,
CONV_POL_TYP_CD,
SRC_CONV_POL_TYP_CD,
CONV_POL_NBR,
ACTVY_CD,
DLVRY_DATA_CD,
SRC_DLVRY_DATA_CD,
BEN_AMT,
DTH_BEN_OPT_CD,
DTH_BEN_OPT_INT_RT,
DTH_BEN_OPT_INT_RT_QLTY_CD,
FACE_AMT,
HONEYMOON_CD,
SRC_HONEYMOON_CD,
FREE_LOOK_EXP_DT,
I_A_CD,
SRC_IA_CD,
LUMP_SUM_BEN_AMT,
MEC_EFF_DT,
MEC_IND,
SRC_MEC_IND,
MEC_STUS_CD,
SRC_MEC_STUS_CD,
NON_FORT_OPT_CD,
OBJ_ADMSPEC_CD,
SRC_OBJ_ADMSPEC_CD,
PURP_INS_CTGY_CD,
PURP_INS_CD,
PAY7_PRD_PREM_AMT,
PAY7_PRD_PREM_END_DT,
PAY7_PRD_PREM_END_DT_QLTY_CD,
PAY7_PRD_PREM_QLTY_CD,
PAY7_PRD_PREM_STRT_DT,
PAY7_PRD_PREM_STRT_DT_QLTY_CD,
PEND_STTL_IND,
REINS_IND,
SRC_REINS_IND,
TCC_AMT,
TMP_TRMN_PRE_EFF_DT,
TMP_TRMN_STUS_CD,
TOT_MTHLY_BEN_AMT,
ULT_FACE_AMT,
YR_TRMN_PRCH_CD,
CURR_IND,
SRC_DEL_IND,
RUN_ID,
SRC_SYS_ID,
UPDT_RUN_ID,
TRANS_DT,
LAPSE_CNTL_DT,
GRACE_PRD_PMT_AMT,
GRACE_PRD_PMT_QLTY_CD,
POL_UNIT_FACE_AMT,
DBO_SHT_NM,
MEC_EFF_DT_QLTY_CD,
VLR_RC,
POL_INC_AMT,
TEL_AUTH_IND,
TAX_AGG_IND,
SRC_TAX_AGG_IND,
TAX_AMT_NOT_DTRMN_IND,
DATE_OF_ASSIGN,
ERLY_PERMT_ANN_DT,
LATE_PERMT_ANN_DT,
SRC_TEL_AUTH_IND,
WDRWL_OPT_CD,
SRC_WDRWL_OPT_CD,
GLWB_STATUS,
SRC_GLWB_STATUS,
GLWB_STATUS_DT,
REIN_TREATY_NR,
EXCESS_WDRWL_IND,
SRC_EXCESS_WDRWL_IND,
VI_RIDER_IND,
PORTABILITY_IND,
PERS_CREDIT_IND,
SRC_PERS_CREDIT_IND,
PERS_CR_STRT_DT,
DTH_BEN_OPT_AGE_CHG,
CURRENT_BATCH
)
SELECT 
AGMT_ID,
AGMT_DATA_FR_DT,
AGMT_BEN_DATA_FR_DT,
AGMT_BEN_DATA_TO_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
ACTY_PEND_CD,
SRC_ACTY_PEND_CD,
ACTY_PEND_WD,
SRC_ACTY_PEND_WD,
APD_IND,
SRC_APD_IND,
APM_NBR,
SRC_APM_NBR,
APL_IND,
SRC_APL_IND,
CONV_IND,
SRC_CONV_IND,
CONV_ELIG_STRT_DT,
CONV_POL_TYP_CD,
SRC_CONV_POL_TYP_CD,
CONV_POL_NBR,
ACTVY_CD,
DLVRY_DATA_CD,
SRC_DLVRY_DATA_CD,
BEN_AMT,
DTH_BEN_OPT_CD,
DTH_BEN_OPT_INT_RT,
DTH_BEN_OPT_INT_RT_QLTY_CD,
FACE_AMT,
HONEYMOON_CD,
SRC_HONEYMOON_CD,
FREE_LOOK_EXP_DT,
I_A_CD,
SRC_IA_CD,
LUMP_SUM_BEN_AMT,
MEC_EFF_DT,
MEC_IND,
SRC_MEC_IND,
MEC_STUS_CD,
SRC_MEC_STUS_CD,
NON_FORT_OPT_CD,
OBJ_ADMSPEC_CD,
SRC_OBJ_ADMSPEC_CD,
PURP_INS_CTGY_CD,
PURP_INS_CD,
PAY7_PRD_PREM_AMT,
PAY7_PRD_PREM_END_DT,
PAY7_PRD_PREM_END_DT_QLTY_CD,
PAY7_PRD_PREM_QLTY_CD,
PAY7_PRD_PREM_STRT_DT,
PAY7_PRD_PREM_STRT_DT_QLTY_CD,
PEND_STTL_IND,
REINS_IND,
SRC_REINS_IND,
TCC_AMT,
TMP_TRMN_PRE_EFF_DT,
TMP_TRMN_STUS_CD,
TOT_MTHLY_BEN_AMT,
ULT_FACE_AMT,
YR_TRMN_PRCH_CD,
CURR_IND,
SRC_DEL_IND,
RUN_ID,
SRC_SYS_ID,
UPDT_RUN_ID,
TRANS_DT,
LAPSE_CNTL_DT,
GRACE_PRD_PMT_AMT,
GRACE_PRD_PMT_QLTY_CD,
POL_UNIT_FACE_AMT,
DBO_SHT_NM,
MEC_EFF_DT_QLTY_CD,
VLR_RC,
POL_INC_AMT,
TEL_AUTH_IND,
TAX_AGG_IND,
SRC_TAX_AGG_IND,
TAX_AMT_NOT_DTRMN_IND,
DATE_OF_ASSIGN,
ERLY_PERMT_ANN_DT,
LATE_PERMT_ANN_DT,
SRC_TEL_AUTH_IND,
WDRWL_OPT_CD,
SRC_WDRWL_OPT_CD,
GLWB_STATUS,
SRC_GLWB_STATUS,
GLWB_STATUS_DT,
REIN_TREATY_NR,
EXCESS_WDRWL_IND,
SRC_EXCESS_WDRWL_IND,
VI_RIDER_IND,
PORTABILITY_IND,
PERS_CREDIT_IND,
SRC_PERS_CREDIT_IND,
PERS_CR_STRT_DT,
DTH_BEN_OPT_AGE_CHG,
TRUE 
FROM 
(
SELECT *,RANK() OVER(PARTITION BY HLDG_KEY,RUN_ID,TRANS_DT,HLDG_KEY_SFX,HLDG_KEY_PFX ORDER BY AGMT_BEN_DATA_TO_DT DESC) AS RANK_NUM
FROM PROD_STND_VW_TERSUN.AGMT_BEN_DATA_VW_AIF_RPS 
WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72 ) T1
WHERE T1.RANK_NUM=1;

-- SNAPSHOT FOR AGMT_DIVIDEND

-- DELETE THE CHANGED RECORD IN SNAPSHOT, MAKE SURE SNAPSHOT IS ALL NEW
DELETE FROM EDW_STAGING.AIFRPS_AGMT_DIVIDEND_VW_SNAPSHOT
WHERE AGMT_ID IN (SELECT AGMT_ID FROM PROD_STND_VW_TERSUN.AGMT_DIVIDEND_VW_AIF_RPS WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72);

-- SET ALL CURRENT_BATCH TO FALSE
UPDATE EDW_STAGING.AIFRPS_AGMT_DIVIDEND_VW_SNAPSHOT
SET CURRENT_BATCH = FALSE
WHERE CURRENT_BATCH = TRUE;

-- INSERT INTO NEW DATA'S
INSERT INTO EDW_STAGING.AIFRPS_AGMT_DIVIDEND_VW_SNAPSHOT
(
AGMT_ID,
AGMT_DATA_FR_DT,
AGMT_DIVD_TO_DT,
AGMT_DIVD_FR_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
DIVD_OPT_CD,
SRC_DIVD_OPT_CD,
SCND_DIVD_OPT_CD,
SRC_SCND_DIVD_OPT_CD,
DIVD_OPT_WD,
SCND_CURR_DIVD_OPT_WD,
DIVD_YR,
CURR_DIVD_AMT,
ACCUM_DIVD_AMT,
ACCUM_DIVD_QLTY_CD,
RP_CURR_DIVD_YR_MTH,
RP_CURR_DIVD_YR,
RP_CURR_DIVD_AMT,
RP_DIVD_AMT,
RP_DIVD_AMT_QLTY_CD,
RI_DIVD_AMT_QLTY_CD,
RI_DIVD_AMT,
APPLD_DIVD_AMT,
APPLD_DIVD_QLTY_CD,
BASE_DIVD_AMT,
BASE_DIVD_QLTY_CD,
PREV_YR_DIVD_AMT,
PREV_YR_DIVD_QLTY_CD,
DIVD_ACCUM_AVL_AMT,
DIVD_ACCUM_AVL_QLTY_CD,
DIVD_AVL_AMT,
DIVD_AVL_QLTY_CD,
LST_DIVD_CRDT_AMT,
LST_DIVD_CRDT_QLTY_CD,
CURR_IND,
SRC_DEL_IND,
SRC_SYS_ID,
RUN_ID,
UPDT_RUN_ID,
TRANS_DT,
LTCIR_DIV_BEN_POOL_AMT,
LTCIR_DIV_BEN_POOL_QLTY_CD,
INT_ON_DIVD_ACCUM_TODT_AMT,
INT_ON_DIVD_ACCUM_TODT_QLTY_CD,
STLMNT_DIVD_AMT,
STLMNT_DIVD_QLTY_CD,
DIVD_ACCUM_TAX_AMT,
DIVD_ACCUM_TAX_QLTY_CD,
DIVD_MO_DA,
CURRENT_BATCH
)
SELECT 
AGMT_ID,
AGMT_DATA_FR_DT,
AGMT_DIVD_TO_DT,
AGMT_DIVD_FR_DT,
HLDG_KEY_PFX,
HLDG_KEY,
HLDG_KEY_SFX,
CARR_ADMIN_SYS_CD,
DIVD_OPT_CD,
SRC_DIVD_OPT_CD,
SCND_DIVD_OPT_CD,
SRC_SCND_DIVD_OPT_CD,
DIVD_OPT_WD,
SCND_CURR_DIVD_OPT_WD,
DIVD_YR,
CURR_DIVD_AMT,
ACCUM_DIVD_AMT,
ACCUM_DIVD_QLTY_CD,
RP_CURR_DIVD_YR_MTH,
RP_CURR_DIVD_YR,
RP_CURR_DIVD_AMT,
RP_DIVD_AMT,
RP_DIVD_AMT_QLTY_CD,
RI_DIVD_AMT_QLTY_CD,
RI_DIVD_AMT,
APPLD_DIVD_AMT,
APPLD_DIVD_QLTY_CD,
BASE_DIVD_AMT,
BASE_DIVD_QLTY_CD,
PREV_YR_DIVD_AMT,
PREV_YR_DIVD_QLTY_CD,
DIVD_ACCUM_AVL_AMT,
DIVD_ACCUM_AVL_QLTY_CD,
DIVD_AVL_AMT,
DIVD_AVL_QLTY_CD,
LST_DIVD_CRDT_AMT,
LST_DIVD_CRDT_QLTY_CD,
CURR_IND,
SRC_DEL_IND,
SRC_SYS_ID,
RUN_ID,
UPDT_RUN_ID,
TRANS_DT,
LTCIR_DIV_BEN_POOL_AMT,
LTCIR_DIV_BEN_POOL_QLTY_CD,
INT_ON_DIVD_ACCUM_TODT_AMT,
INT_ON_DIVD_ACCUM_TODT_QLTY_CD,
STLMNT_DIVD_AMT,
STLMNT_DIVD_QLTY_CD,
DIVD_ACCUM_TAX_AMT,
DIVD_ACCUM_TAX_QLTY_CD,
DIVD_MO_DA,
TRUE 
FROM (
SELECT *,RANK() OVER(PARTITION BY HLDG_KEY,RUN_ID,TRANS_DT,HLDG_KEY_SFX,HLDG_KEY_PFX ORDER BY AGMT_DIVD_TO_DT DESC) AS RANK_NUM
FROM PROD_STND_VW_TERSUN.AGMT_DIVIDEND_VW_AIF_RPS 
WHERE RUN_ID = :RUN_ID AND SRC_SYS_ID = 72 ) T1
WHERE T1.RANK_NUM=1;
